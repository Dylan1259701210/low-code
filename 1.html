import React from 'react';
import { Table, Button, Space } from 'antd';
import { DownloadOutlined } from '@ant-design/icons';

const exportToCSV = (dataSource, fileName = '导出数据', headers) => {
  const csvHeaders = headers || Object.keys(dataSource[0] || {});
  
  const csvRows = dataSource.map(row => 
    csvHeaders.map((headerKey, index) => {
      const dataKey = headers ? Object.keys(dataSource[0] || {})[index] : headerKey;
      let value = row[dataKey] ?? '';
      const strValue = String(value);

      // 最小化转义：只加双引号包裹（不修改内部内容），解决 Excel 列错位问题
      // 触发条件：字段包含 逗号、双引号、换行符（这些会破坏 CSV 格式）
      if (strValue.includes(',') || strValue.includes('"') || strValue.includes('\n')) {
        return `"${strValue}"`; // 只包裹，不转义内部的逗号/引号
      }

      return strValue;
    }).join(',')
  );

  // 加 UTF-8-BOM 编码，兼容 Excel 中文显示
  const csvContent = '\uFEFF' + [...csvHeaders, ...csvRows].join('\r\n');

  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  
  link.href = url;
  link.download = `${fileName}.csv`;
  link.click();
  URL.revokeObjectURL(url);
};

// 测试数据（包含 JSON 里的逗号）
const TableExportDemo = () => {
  const dataSource = [
    {
      id: 1,
      name: '张三',
      jsonData: JSON.stringify({ name: '张三', age: 25, tags: ['前端', 'React'] }, null, 2), // JSON 里有逗号
      desc: '包含"双引号"和,逗号的描述'
    },
    {
      id: 2,
      name: '李四',
      jsonData: JSON.stringify({ name: '李四', address: '北京市朝阳区, 建国路' }, null, 2), // 地址里有逗号
      desc: '纯文本无特殊字符'
    },
  ];

  const columns = [
    { title: 'ID', dataIndex: 'id', key: 'id' },
    { title: '姓名', dataIndex: 'name', key: 'name' },
    { title: 'JSON 数据', dataIndex: 'jsonData', key: 'jsonData' },
    { title: '描述', dataIndex: 'desc', key: 'desc' },
  ];

  return (
    <div style={{ padding: 20 }}>
      <Space style={{ marginBottom: 16 }}>
        <Button 
          type="primary" 
          icon={<DownloadOutlined />}
          onClick={() => exportToCSV(dataSource, 'JSON含逗号数据', ['序号', '姓名', 'JSON原始数据', '描述信息'])}
        >
          导出 CSV（兼容 Excel）
        </Button>
      </Space>
      <Table dataSource={dataSource} columns={columns} rowKey="id" bordered scroll={{ x: 1200 }} />
    </div>
  );
};

export default TableExportDemo;


import React, { useState } from 'react';
import { Table, Button, Space, Progress, message } from 'antd';
import { DownloadOutlined } from '@ant-design/icons';
import * as XLSX from 'xlsx';

// 核心优化：大数据量分片导出 .xlsx（支持 10 万+ 行，Office 365 兼容）
const exportLargeDataToExcel = async (
  dataSource,
  fileName = '大数据导出',
  headers,
  chunkSize = 5000 // 分片大小（可调整：内存充足用 1 万，内存紧张用 3000）
) => {
  const start = Date.now();
  const [progress, setProgress] = useState(0); // 导出进度（用于 UI 展示）

  try {
    // 1. 初始化工作簿和流式写入器（核心优化：流式 API）
    const workbook = XLSX.utils.book_new();
    const worksheet = XLSX.utils.worksheet_new();
    const writer = XLSX.stream.XLSXWriter(workbook, {
      bookType: 'xlsx',
      type: 'array',
      cellStyles: false, // 关闭样式（非必需，进一步降低内存占用）
    });

    // 2. 处理表头
    const dataKeys = Object.keys(dataSource[0] || {});
    const excelHeaders = headers || dataKeys;
    // 写入表头（第一行）
    XLSX.utils.sheet_add_aoa(worksheet, [excelHeaders], { origin: 'A1' });

    // 3. 分片处理数据（核心优化：分片 + 异步处理）
    const totalChunks = Math.ceil(dataSource.length / chunkSize); // 总分片数

    for (let chunkIndex = 0; chunkIndex < totalChunks; chunkIndex++) {
      // 计算当前分片的起始和结束索引
      const startIndex = chunkIndex * chunkSize;
      const endIndex = Math.min(startIndex + chunkSize, dataSource.length);
      const chunkData = dataSource.slice(startIndex, endIndex); // 当前分片数据

      // 4. 分片写入工作表（避免一次性加载所有数据）
      const rowData = chunkData.map(row => 
        dataKeys.map(key => row[key] ?? '') // 原样保留原始数据（JSON、逗号等）
      );
      // 计算当前分片的写入起始位置（表头占 1 行，所以 +1）
      const origin = `A${startIndex + 2}`;
      XLSX.utils.sheet_add_aoa(worksheet, rowData, { origin, skipHeader: true });

      // 5. 更新进度（UI 反馈，避免用户以为卡住）
      const currentProgress = Math.round(((chunkIndex + 1) / totalChunks) * 100);
      setProgress(currentProgress);

      // 6. 给主线程让步（核心优化：避免阻塞浏览器）
      await new Promise(resolve => setTimeout(resolve, 10));
    }

    // 7. 完成工作簿构建，触发下载
    XLSX.utils.book_append_sheet(workbook, worksheet, '数据列表');
    const excelBuffer = await writer.writeBuffer(); // 流式生成文件缓冲区
    const blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });

    // 触发下载
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `${fileName}.xlsx`;
    link.click();
    URL.revokeObjectURL(url);

    const timeCost = (Date.now() - start) / 1000;
    message.success(`导出成功！共 ${dataSource.length} 行数据，耗时 ${timeCost.toFixed(1)} 秒`);
  } catch (error) {
    console.error('导出失败：', error);
    message.error('导出失败，请重试！');
  }
};

// 模拟大数据量数据源（测试用：生成 10 万行数据）
const generateLargeDataSource = (rowCount = 100000) => {
  const data = [];
  for (let i = 1; i <= rowCount; i++) {
    data.push({
      id: i,
      name: `用户${i}`,
      age: Math.floor(Math.random() * 30) + 20,
      jsonData: JSON.stringify({
        id: i,
        tags: [`标签${i}`, `分类${Math.floor(Math.random() * 10)}`, '大数据导出'],
        address: `城市${Math.floor(Math.random() * 20)} 街道${i}号`
      }, null, 2), // JSON 含逗号，原样保留
      createTime: new Date().toLocaleString()
    });
  }
  return data;
};

const LargeDataExportDemo = () => {
  const [exportProgress, setExportProgress] = useState(0);
  const [isExporting, setIsExporting] = useState(false);

  // 模拟 10 万行大数据（实际使用时替换为你的真实数据源）
  const largeDataSource = generateLargeDataSource(100000);

  // 表格列配置
  const columns = [
    { title: 'ID', dataIndex: 'id', key: 'id' },
    { title: '姓名', dataIndex: 'name', key: 'name' },
    { title: '年龄', dataIndex: 'age', key: 'age' },
    { title: 'JSON 数据', dataIndex: 'jsonData', key: 'jsonData' },
    { title: '创建时间', dataIndex: 'createTime', key: 'createTime' },
  ];

  // 导出触发函数（包装一层，处理进度状态）
  const handleExport = async () => {
    setIsExporting(true);
    setExportProgress(0);

    // 监听进度更新（通过闭包传递进度）
    const originalSetProgress = window.setProgress;
    window.setProgress = (progress) => {
      setExportProgress(progress);
    };

    try {
      await exportLargeDataToExcel(
        largeDataSource,
        '10万行大数据导出',
        ['序号', '姓名', '年龄', 'JSON 原始数据', '创建时间'],
        5000 // 每片 5000 行（根据实际内存调整）
      );
    } finally {
      window.setProgress = originalSetProgress;
      setIsExporting(false);
      setExportProgress(0);
    }
  };

  return (
    <div style={{ padding: 20 }}>
      <Space style={{ marginBottom: 16 }}>
        <Button
          type="primary"
          icon={<DownloadOutlined />}
          onClick={handleExport}
          disabled={isExporting}
        >
          {isExporting ? '导出中...' : '导出 10 万行数据'}
        </Button>
      </Space>

      {/* 导出进度条（大数据量必备，提升用户体验） */}
      {isExporting && (
        <Progress
          percent={exportProgress}
          status="active"
          strokeWidth={4}
          style={{ marginBottom: 16 }}
        />
      )}

      {/* AntD Table（只展示前 10 行，避免渲染 10 万行导致页面卡顿） */}
      <Table
        dataSource={largeDataSource.slice(0, 10)} // 仅展示前 10 行
        columns={columns}
        rowKey="id"
        bordered
        pagination={{ pageSize: 10 }}
        scroll={{ x: 1500 }}
        title={() => '大数据量示例（实际导出 10 万行）'}
      />
    </div>
  );
};

export default LargeDataExportDemo;